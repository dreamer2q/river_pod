---
title: Providers
---

既然我们已经安装了 [Riverpod]，现在来讨论一下 “providers”。

Providers 在一个 [Riverpod] 的应用程序中发挥着重要的作用。

一个 provider 就是一个对象，它针对一个状态进行封装，同时可以监听状态改变事件。

## 为何使用 providers?

使用 provider 封装状态：

- 让你可以在多处位置轻松访问这个状态。
  Providers 可以完全替代 Singletons (单例模式)、Service Locators (服务定位模式)、Dependency Injection (依赖注入) 或 InheritedWidgets (继承 Widget) 等模式。

- 简化合并多个状态对象的操作。
  你经常遇到需要将多个对象合并为一个对象的情况？这种情况就直接在 provider 中实现了。

- 启用性能优化。
  是否需要对状态进行过滤，或者是否需要对计算较为耗时的状态进行缓存？
  providers 可以保证只有当状态改变时，才会重新计算相关的状态。

- 增加了你的应用程序的可测试性。
  使用 providers，你不需要复杂的 `setUp`/`tearDown` 步骤。
  同时，任何 provider 可以在测试中被覆盖，从而达到测试特定行为的目的。

- 可以让你更好地集成到高级功能，例如日志或者下拉刷新。

## 创建一个 provider

Providers 有很多变种，但是它们本质都是一样的。

最常见的用法是将它们声明为全局常量，如下所示：

```dart
final myProvider = Provider((ref) {
  return MyValue();
});
```

:::note
不要因为 providers 是全局的而感到担忧。
Providers 是完全不可变的。声明一个 provider 和声明一个函数没有什么不同，此外 providers 可以被测试和维护。
:::

这段代码由三个部分组成：

- `final myProvider`，声明一个变量。
  这个变量将在未来用于读取我们的 provider 的状态。
  providers 应该总是是 `final`。

- `Provider`，我们选择使用的 provider。
  [Provider] 是所有 providers 的基础。它只会暴露一个不会改变的对象。
  我们可以替换 [Provider] 为其他 providers，例如 [StreamProvider] 或 [StateNotifierProvider]，
  以改变如何与返回值进行交互。

- 一个函数，用于创建共享状态。
  这个函数将在参数中接收一个名为 `ref` 的对象。这个对象允许我们读取其他 providers，
  在我们的 provider 的状态将被销毁时执行一些操作，等等。

函数返回的对象的类型取决于使用的 provider。
例如，[Provider] 的创建函数可以返回任何对象。
另一方面，[StreamProvider] 的回调函数只能返回一个 [Stream]。

:::info
你可以声明你想要的任意多个 providers ，不受限制。
与 `package:provider` 不同，[Riverpod] 允许创建多个 providers 拥有相同 “类型” 的状态：

```dart
final cityProvider = Provider((ref) => 'London');
final countryProvider = Provider((ref) => 'England');
```

事实上，这两个 providers 创建相同类型的 `String` 不会导致任何问题。
:::

:::caution

如果想要 providers 可以工作，你必须在你的 Flutter 应用的根节点添加 [ProviderScope]：

```dart
void main() {
  runApp(ProviderScope(child: MyApp()));
}
```

:::

## 不同类型的 Providers

有多种不同用途的 providers。

这么多种不同用途的 providers，有时很难理解一种 provider 类型是否更适合使用。
下面的表格可以帮助你选择一种最适合你使用的 provider 类型。

| Provider 类型            | Provider 创建函数返回类型      | 使用示例                                         |
| ------------------------ | ------------------------------ | ------------------------------------------------ |
| [Provider]               | 返回任何类型                   | 一个服务类型 / 计算属性 (筛选后的列表)           |
| [StateProvider]          | 返回任何类型                   | 一个筛选条件 / 简单状态对象                      |
| [FutureProvider]         | 返回任何 Future 类型           | 一个异步 API 调用的返回内容                      |
| [StreamProvider]         | 返回任何 Stream 类型           | 一个 API 调用的返回的 Stream 流内容              |
| [StateNotifierProvider]  | 返回任何 StateNotifier 的子类  | 一个不可变的复杂状态对象，只能通过接口来改变状态 |
| [ChangeNotifierProvider] | 返回任何 ChangeNotifier 的之类 | 一个可变的复杂状态对象                           |

:::caution
尽管所有的 providers 都有他们的用途，但是由于可变对象自身的问题，因此 [ChangeNotifierProvider]s 不适用于可扩展的应用程序，
它在 `flutter_riverpod` 包中存在，用于提供一个简单的迁移路径来从 `package:provider` 中过渡，
并允许在一些 flutter 特定的使用场景中使用，例如与一些 Navigator 2 包的集成。
:::

## Provider 的修饰符

所有的 providers 都有一个内置的方法来为不同 providers 添加额外的功能。

它可以添加新的功能到 `ref` 对象，或者改变 provider 的消费方式。

修饰符可以在所有 providers 上使用，与命名构造器类似的语法：

```dart
final myAutoDisposeProvider = StateProvider.autoDispose<int>((ref) => 0);
final myFamilyProvider = Provider.family<String, int>((ref, id) => '$id');
```

现阶段，有两种修饰符：

- [`.autoDispose`](/docs/concepts/modifiers/auto_dispose), 当它不再被监听时，可以自动销毁 provider 的状态。

- [`.family`](/docs/concepts/modifiers/family), 允许从外部参数创建 provider。

:::note
一个 provider 可以同时使用多个修饰符：

```dart
final userProvider = FutureProvider.autoDispose.family<User, int>((ref, userId) async {
  return fetchUser(userId);
});
```

:::

这里就是这篇指南的整个内容了！

你可以继续阅读 [如何使用一个 provider](/docs/concepts/reading)。

或者，你可以看 [如何组合 providers](/docs/concepts/combining_providers)。

[get_it]: http://pub.dev/packages/get_it
[inheritedwidget]: https://api.flutter.dev/flutter/widgets/InheritedWidget-class.html
[stream]: https://api.dart.dev/stable/2.8.4/dart-async/Stream-class.html
[ondispose]: https://pub.dev/documentation/riverpod/latest/riverpod/Ref/onDispose.html
[riverpod]: https://github.com/rrousselgit/river_pod
[hooks_riverpod]: https://pub.dev/packages/hooks_riverpod
[flutter_riverpod]: https://pub.dev/packages/flutter_riverpod
[flutter_hooks]: https://github.com/rrousselGit/flutter_hooks
[provider]: /docs/providers/provider
[streamprovider]: /docs/providers/stream_provider
[futureprovider]: /docs/providers/future_provider
[stateprovider]: /docs/providers/state_provider
[statenotifierprovider]: /docs/providers/state_notifier_provider
[changenotifierprovider]: https://pub.dev/documentation/flutter_riverpod/latest/flutter_riverpod/ChangeNotifierProvider-class.html
[providerscope]: https://pub.dev/documentation/flutter_riverpod/latest/flutter_riverpod/ProviderScope-class.html
